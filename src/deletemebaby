/* 
 set the @reporting_month_start_date before you run this report. probably
 
 https://docs.google.com/spreadsheets/d/1Wvd2gi-wKdbYRsOtp3udg1hsJvj15642u7vfrqx-XgM/edit#gid=1211767445
 https://docs.google.com/spreadsheets/d/1Wvd2gi-wKdbYRsOtp3udg1hsJvj15642u7vfrqx-XgM/edit#gid=1211767445
 https://docs.google.com/spreadsheets/d/1Wvd2gi-wKdbYRsOtp3udg1hsJvj15642u7vfrqx-XgM/edit#gid=1211767445
 https://docs.google.com/spreadsheets/d/1Wvd2gi-wKdbYRsOtp3udg1hsJvj15642u7vfrqx-XgM/edit#gid=1211767445
 */
IF Object_id ('tempdb..#temptable1') IS NOT NULL DROP TABLE #temptable1 
IF Object_id ('tempdb..#temptable2') IS NOT NULL DROP TABLE #temptable2 
declare @reporting_month_start_date date,
@start_date_target_month date --
--set current month start date 
--(the report will list patients whose most recent eye visit was 13 months prior to that month)
--Pts w/ most recent eye visit 13  months prior to that month
SET
    @reporting_month_start_date = '2023-06-01'
SET
    @start_date_target_month = dateadd(MONTH, -13, @reporting_month_start_date) --pull all vision visits from 1st day of the month 13 months prior to the current month and classify as whether or not they were in the exact month 13 months prior
SELECT
    'https://docs.google.com/spreadsheets/d/1Wvd2gi-wKdbYRsOtp3udg1hsJvj15642u7vfrqx-XgM/edit#gid=1211767445' AS 'link'
SELECT
    e.status,
    e.patientid,
    p.controlno,
    u.ufname,
    u.ulname,
    u.dob,
    u.umobileno,
    u.upphone,
    CONVERT(date, e.date) AS date,
    CASE
        WHEN (
            MONTH(e.date) = MONTH(@start_date_target_month)
            AND year(e.date) = year(@start_date_target_month)
        ) THEN 'visit 13 months prior'
        ELSE ''
    END AS target_month_status INTO #temptable1
FROM
    enc e,
    patients p,
    users u
WHERE
    p.pid = e.patientid
    AND p.pid = u.uid
    AND e.visittype LIKE 'EYE%'
    AND e.status = 'CHK'
    AND u.ulname <> 'Test'
    AND e.date BETWEEN @start_date_target_month
    AND getdate()
    AND e.deleteflag = 0
ORDER BY
    p.controlno,
    e.patientid,
    e.date DESC --pull most recent eye visit for those patients 
SELECT
    DISTINCT t1.patientid,
    t1.controlno,
    max(t1.date) AS max_date INTO #temptable2
FROM
    #temptable1 t1
GROUP BY
    t1.controlno,
    t1.patientid
SELECT
    'Pts with most recent eye visit in target month' AS Title,
    concat(
        format (
            dateadd(MONTH, 1, @start_date_target_month),
            'MMMM'
        ),
        '-',
        year(@start_date_target_month)
    ) AS target_month --merge in whether the most recent visit was in the month 13 months prior
SELECT
    t2.controlno,
    t1.ufname,
    t1.ulname,
    t1.dob,
    t1.umobileno,
    t1.upphone,
    t2.max_date AS date_most_recent_eye_visit
FROM
    #temptable2 t2, #temptable1 t1
WHERE
    t2.patientid = t1.patientid
    AND t2.max_date = t1.date
    AND t1.target_month_status = 'visit 13 months prior'