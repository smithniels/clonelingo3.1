-- Go to the Koz folder to find and fill in the last report.
-- UPDATE 2/17/2023
-- This report is no longer being used for the grant, so I'm only sharing with Randi/@data, so 
-- ** Koz no longer needs to be sent this.
-- The Master SSP Spreadsheet
-- https://docs.google.com/spreadsheets/d/1atMWR-oYCBnPXa37VNrEQKdY-KOxMyrxKZ31rYpf_J0/edit#gid=0
-- https://docs.google.com/spreadsheets/d/1atMWR-oYCBnPXa37VNrEQKdY-KOxMyrxKZ31rYpf_J0/edit#gid=0
-- https://docs.google.com/spreadsheets/d/1atMWR-oYCBnPXa37VNrEQKdY-KOxMyrxKZ31rYpf_J0/edit#gid=0
-- https://docs.google.com/spreadsheets/d/1atMWR-oYCBnPXa37VNrEQKdY-KOxMyrxKZ31rYpf_J0/edit#gid=0
-- https://docs.google.com/spreadsheets/d/1atMWR-oYCBnPXa37VNrEQKdY-KOxMyrxKZ31rYpf_J0/edit#gid=0
DROP TABLE IF EXISTS #temptable1 -- all structured data from exch encs in period
DROP TABLE IF EXISTS #temptable2-- syringes in
DROP TABLE IF EXISTS #temptable3-- syringes out
--Raceother for pts this month
DROP TABLE IF EXISTS #temptableA
DROP TABLE IF EXISTS #temptableB
DROP TABLE IF EXISTS #temptableC
--SOGI
DROP TABLE IF EXISTS #temptable6b--SO
DROP TABLE IF EXISTS #temptable7b--GI
DROP TABLE IF EXISTS #temptable17--race classifications
--this month
DROP TABLE IF EXISTS #temptable20--age group under 15
DROP TABLE IF EXISTS #temptable21--age group 15-19
DROP TABLE IF EXISTS #temptable22--age group 20-29
DROP TABLE IF EXISTS #temptable23--age group under 30-65
DROP TABLE IF EXISTS #temptable24--age group 66+
DROP TABLE IF EXISTS #temptable25--combine all age groups
DROP TABLE IF EXISTS #temptable26--monthly demographics
--YTD
DROP TABLE IF EXISTS #temptablea27--YTD patients
DROP TABLE IF EXISTS #temptablea6b--YTD SO
DROP TABLE IF EXISTS #temptablea7b--YTD GI
DROP TABLE IF EXISTS #temptablea17--YTD race classifications
--Raceother for pts YTD
DROP TABLE IF EXISTS #temptableAa
DROP TABLE IF EXISTS #temptableaB
DROP TABLE IF EXISTS #temptableaC
DROP TABLE IF EXISTS #temptablea20--YTD age group under 15
DROP TABLE IF EXISTS #temptablea21--YTD age group 15-19
DROP TABLE IF EXISTS #temptablea22--YTD age group 20-29
DROP TABLE IF EXISTS #temptablea23--YTD age group under 30-65
DROP TABLE IF EXISTS #temptablea24--YTD age group 66+
DROP TABLE IF EXISTS #temptablea25--TYD combine all age groups
DROP TABLE IF EXISTS #temptablea26--YTD demographics
-- --Manual Date Range Code
-- DECLARE @startdate DATE, 
--         @enddate   DATE 
-- SET @startDate = '07/01/2022'
-- SET @endDate   = '07/31/2022' 
-- select @startdate as startdate
-- select @enddate as enddate
--Automatic Date Range Code (Last Month)
DECLARE @startdate DATETIME,
@enddate DATETIME
SET
    @startDate = Dateadd(DAY, 1, Eomonth(Getdate(), -2)) -- Dateadd is adding one Day to what's being returned by EOMONTH
SELECT
    Concat(
        Datename(MONTH, @startdate),
        ' ',
        Year(@startdate)
    ) AS 'Monthly SSP Report'
SELECT
    Dateadd(DAY, 1, Eomonth(Getdate(), -2)) First_Day
SET
    @endDate = Eomonth(Getdate(), -1)
SELECT
    CONVERT(DATE, @enddate) AS 'Last_Day' -- EOMONTH() pulls the last day of the month FROM the date provided
    --pull structured hpi fields FROM every Exch visit in reporting period
SELECT
    p.controlno,
    p.pid,
    u.ufname,
    u.ulname,
    u.dob,
    Datediff(HOUR, u.ptdob, '2022-06-30') / 8766 AS age,
    CASE
        WHEN DATEDIFF(HOUR, u.ptdob, '2022-06-30') / 8766 < 15 THEN 1
        ELSE 0
    END AS Under_15,
    CASE
        WHEN (
            DATEDIFF(HOUR, u.ptdob, '2022-06-30') / 8766 >= 15
            AND DATEDIFF(HOUR, u.ptdob, '2022-06-30') / 8766 <= 19
        ) THEN 1
        ELSE 0
    END AS _15_19,
    CASE
        WHEN (
            DATEDIFF(HOUR, u.ptdob, '2022-06-30') / 8766 >= 20
            AND DATEDIFF(HOUR, u.ptdob, '2022-06-30') / 8766 <= 29
        ) THEN 1
        ELSE 0
    END AS _20_29,
    CASE
        WHEN (
            DATEDIFF(HOUR, u.ptdob, '2022-06-30') / 8766 >= 30
            AND DATEDIFF(HOUR, u.ptdob, '2022-06-30') / 8766 <= 65
        ) THEN 1
        ELSE 0
    END AS _30_65,
    CASE
        WHEN (
            DATEDIFF(HOUR, u.ptdob, '2022-06-30') / 8766 >= 66
        ) THEN 1
        ELSE 0
    END AS over_66,
    eth.name AS ethnicity,
    CASE
        WHEN eth.name LIKE 'Hispanic or Latino' THEN 1
        ELSE 0
    END AS Latino,
    u.sex,
    CONVERT(DATE, e.date) AS visit_date,
    e.encounterid,
    e.visittype,
    e.status,
    sdd.id,
    sdd.NAME,
    shpi.value,
    CASE
        WHEN CONVERT(VARCHAR, shpi.value) = 'Yes' THEN '1'
        WHEN CONVERT(VARCHAR, shpi.value) = 'No' THEN '0'
        ELSE CONVERT(VARCHAR, shpi.value)
    END AS Value_ML INTO #temptable1
FROM
    users u,
    enc e,
    structhpi shpi,
    structdatadetail sdd,
    patients p
    LEFT JOIN ethnicity eth ON p.ethnicity = eth.code
WHERE
    p.pid = u.uid
    AND p.pid = e.patientid
    AND e.encounterid = shpi.encounterid
    AND shpi.detailid = sdd.id
    AND sdd.id IN (
        '1260',
        '1261',
        '1262',
        '1263',
        '1397',
        '2561'
        /* Overdose # */
    )
    AND e.deleteflag = '0'
    AND e.date BETWEEN @startdate
    AND @enddate
    AND e.status = 'CHK'
    AND sdd.deleteflag = '0'
    AND (
        e.visittype LIKE 'EXCH%'
        OR e.visittype LIKE 'MAT%'
    )
    AND u.ulname NOT LIKE 'Test' --unique pts, encs, new pts seen for exchange in period
SELECT
    count (DISTINCT pid) AS unique_pts_in_pd
FROM
    #temptable1
SELECT
    count (DISTINCT encounterid) AS unique_encs_in_pd
FROM
    #temptable1
SELECT
    count (DISTINCT pid) AS unique_new_pt_in_pd
FROM
    #temptable1 where visittype like 'Exch-new'
SELECT
    CASE
        WHEN (
            id = 1261
            AND isnumeric(value) = 1
        ) THEN CONVERT(int,(value))
        ELSE 0
    END AS syringes_out INTO #temptable2 from #temptable1 
SELECT
    sum(syringes_out) AS syringes_out
FROM
    #temptable2
SELECT
    CASE
        WHEN (
            id = 1260
            AND isnumeric(value) = 1
        ) THEN CONVERT(int,(value))
        ELSE 0
    END AS syringes_in INTO #temptable3 from #temptable1 
SELECT
    sum(syringes_in) AS syringes_in
FROM
    #temptable3
SELECT
    count(DISTINCT encounterid) AS num_equip_distrib
FROM
    #temptable1 where id=1262 and value='Yes'
    /* HIV Testing  */
SELECT
    count (DISTINCT t1.pid) AS 'pts_ tested_for_HIV'
FROM
    labdata l,
    items i,
    enc e,
    #temptable1 t1
WHERE
    e.date BETWEEN @startdate
    AND @enddate
    AND t1.pid = e.patientid
    AND e.encounterid = l.encounterid
    AND i.itemid = l.itemid
    AND l.itemid IN (
        '250311',
        '302257',
        '292082',
        '262566',
        '302207',
        '262567',
        '290543',
        '290147',
        '316259',
        '290755',
        '250454',
        '291682',
        '251611',
        '291793',
        '251628',
        '250433',
        '291962',
        '410525'
    )
    AND l.result <> '' --/* HCV Testing  */
SELECT
    count (DISTINCT t1.pid) AS 'pts_ tested_for_HCV'
FROM
    #temptable1 t1, enc e
    LEFT JOIN labdata l ON e.encounterid = l.encounterid
    LEFT JOIN labdatadetail ldd ON ldd.reportid = l.reportid
    LEFT JOIN items it ON l.itemid = it.itemid
WHERE
    e.patientid = t1.pid
    AND e.date BETWEEN @startdate
    AND @enddate
    AND it.itemid IN ('237687', '302407', '313281', '290735', '305292')
    AND l.deleteflag = '0'
    AND e.deleteflag = '0'
    AND e.status = 'CHK'
    /* STD Testing */
    /* Chlamydia.Gonorrea.Syphilis.HIV */
SELECT
    count (DISTINCT t1.pid) AS 'pts_ tested_for_STIs'
FROM
    #temptable1 t1, enc e, items i, labdata ld
WHERE
    t1.pid = e.patientid
    AND e.encounterid = ld.encounterid
    AND ld.itemid = i.itemid
    AND ld.deleteflag = '0'
    AND e.date BETWEEN @startdate
    AND @enddate
    AND (
        -- Chlamydia
        i.itemid IN (
            '305296',
            '250324',
            '242632',
            '239730',
            '240088',
            '242757',
            '244309',
            '302245',
            '244272',
            '237913',
            '242669',
            '237472',
            '243921',
            '303221',
            '302243',
            '290249',
            '290809',
            '290802',
            '290582',
            '290765',
            '314892',
            '319201',
            '290955',
            '290919',
            '237944',
            '251279',
            '250976',
            '251058',
            '250677'
        )
        OR -- Gonorrhea
        ld.itemid IN ('290802', '319201', '290955', '290802')
        OR -- Syphilis
        i.itemid IN (
            '290169',
            '290341',
            '250683',
            '250686',
            '302248',
            '236627',
            '239449',
            '302205',
            '302261',
            '302474',
            '302259',
            '236795'
        )
        OR -- HIV
        ld.itemid IN (
            '290543',
            '291962',
            '290169',
            '290341',
            '250683',
            '250686',
            '302248',
            '236627',
            '239449',
            '302205',
            '302261',
            '302474',
            '302259',
            '236795'
        )
    )
    AND ld.result <> ''
    /*Medical visits*/
SELECT
    count (DISTINCT t1.pid) AS 'pts_w_primary_medical_care_visit'
FROM
    #temptable1 t1, enc e
WHERE
    t1.pid = e.patientid
    AND e.date BETWEEN @startdate
    AND @enddate
    AND e.visittype IN (
        'ADULT-FU',
        'ADULT-NEW',
        'ADULT-PE',
        'ADULT-URG',
        'CONFDNTL',
        'PED-PRENAT',
        'PED-PRENAT-NEW',
        'PEDS-FU',
        'PEDS-PE',
        'PEDS-URG',
        'GYN-FU',
        'GYN-NEW',
        'RCM-OFF',
        'Deaf-fu',
        'Deaf-new',
        'MED-TV',
        'MED-Audio',
        'BHC-AUDIO',
        'BHC-TV',
        'den-audio',
        'den-tv',
        'eye-audio',
        'eye-tv'
    )
    AND e.status = 'chk'
    AND e.deleteFlag = '0' --number narcan doses given
SELECT
    count(DISTINCT encounterid) AS num_narcan_doses_given
FROM
    #temptable1 where id=1397 and value='Yes'
    --number of patients who received MAT 
SELECT
    count (DISTINCT t1.pid) AS 'pts_w_MAT_visit'
FROM
    #temptable1 t1, enc e
WHERE
    t1.pid = e.patientid
    AND e.date BETWEEN @startdate
    AND @enddate
    AND e.visittype LIKE '%MAT%'
    AND e.status = 'chk'
    AND e.deleteFlag = '0' --pull race for pts in who had exchange visit in period (#temptable1) Will have multiple rows for pts w more than one race
SELECT
    DISTINCT t1.pid,
    ro.name AS race,
    1 AS count INTO #temptablea
FROM
    #temptable1 t1
    LEFT JOIN raceothers ro ON t1.pid = ro.pid --identify pts with more than one row from above
SELECT
    DISTINCT ta.pid,
    sum(count) AS count INTO #temptableb
FROM
    #temptablea ta
GROUP BY
    ta.pid --classify patients by race, using multiracial if they have more than one row in raceothers
SELECT
    DISTINCT t1.pid,
    t1.ethnicity,
    CASE
        WHEN tb.count >= 2 THEN 'Multiracial'
        WHEN ta.race LIKE 'Black or African American' THEN 'Black/African American'
        WHEN ta.race LIKE 'American Indian or Alaska Native' THEN 'American Indian/Alaska Native'
        WHEN (
            ta.race LIKE 'Native Hawaiian'
            OR ta.race LIKE 'Other Pacific Islander'
        ) THEN 'Native Hawaiian/Other Pacific Islander'
        WHEN ta.race LIKE 'Asian' THEN 'Asian'
        WHEN (
            ta.race LIKE ''
            OR ta.race LIKE 'Declined to Specify'
        ) THEN 'Other/Unknown'
        ELSE ta.race
    END AS Race INTO #temptablec
FROM
    #temptable1 t1 
    LEFT JOIN #temptablea ta on t1.pid=ta.pid
    LEFT JOIN #temptableb tb on t1.pid=tb.pid
    -- SOGI */
    --pull so 
SELECT
    t1.pid,
    pso.so_ID,
    soo.name AS sexual_orientation,
    CONVERT(date, pso.added_on) AS so_date_updated INTO #temptable6b
FROM
    #temptable1 t1
    LEFT JOIN patient_sexual_orientation pso ON t1.pid = pso.patientid
    AND pso.deleteflag = 0
    LEFT JOIN sexual_orientation_options soo ON pso.so_id = soo.id --pull gi  
SELECT
    t1.pid,
    pgi.gi_ID,
    gio.name AS gender_identity,
    CONVERT(date, pgi.added_on) AS gi_date_updated INTO #temptable7b
FROM
    #temptable1 t1
    LEFT JOIN patient_gender_identity pgi ON t1.pid = pgi.patientid
    AND pgi.deleteflag = 0
    LEFT JOIN gender_identity_options gio ON pgi.gi_id = gio.id --this month's demographics for Cumulative Demographic Report with ethnicity and race organized for that table
SELECT
    DISTINCT t1.pid,
    t1.under_15,
    t1._15_19,
    t1._20_29,
    t1._30_65,
    t1.over_66,
    CASE
        WHEN t1.Latino = 1 THEN '3_Latino'
        WHEN tc.race LIKE 'Black%' THEN '1_Black'
        WHEN (
            tc.race LIKE 'Asian'
            OR tc.race LIKE 'Native%'
        ) THEN '4_API'
        WHEN tc.race LIKE 'White' THEN '2_White'
        ELSE '5_Other/Unknown'
    END AS race,
    CASE
        WHEN t7b.gender_identity LIKE '%trans%' THEN 1
        ELSE 0
    END AS Trans,
    CASE
        WHEN t1.sex LIKE 'Female' THEN 1
        ELSE 0
    END AS Female,
    CASE
        WHEN t1.sex LIKE 'Male' THEN 1
        ELSE 0
    END AS male,
    CASE
        WHEN (
            t1.sex NOT LIKE 'Female'
            AND t1.sex NOT LIKE 'Male'
            AND t7b.gender_identity NOT LIKE 'Trans'
        ) THEN 1
        ELSE 0
    END AS Unknown INTO #temptable17
FROM
    #temptable1 t1
    LEFT JOIN #temptable6b t6b on t1.pid=t6b.pid
    LEFT JOIN #temptable7b t7b on t1.pid=t7b.pid
    LEFT JOIN #temptablec tc on t1.pid=tc.pid
    /*
     --'Cumulative Demographics Under 15' 
     select distinct t17.race, sum(t17.male) as M_under_15, sum(t17.female) as F_under_15, sum(t17.trans) as T_under_15, sum(t17.unknown) as unknown_under_15
     into #temptable20
     from #temptable17 t17
     where t17.under_15=1
     group by t17.race
     
     --'Cumulative Demographics 15-19' 
     select distinct t17.race, sum(t17.male) as M_15_19, sum(t17.female) as F_15_19, sum(t17.trans) as T_15_19, sum(t17.unknown) as unknown_15_19
     into #temptable21
     from #temptable17 t17
     where t17._15_19=1
     group by t17.race
     
     --'Cumulative Demographics 20-29'
     select distinct t17.race, sum(t17.male) as M_20_29, sum(t17.female) as F_20_29, sum(t17.trans) as T_20_29, sum(t17.unknown) as unknown_20_29
     into #temptable22
     from #temptable17 t17
     where t17._20_29=1
     group by t17.race
     
     --'Cumulative Demographics 30-65' 
     select distinct t17.race, sum(t17.male) as M_30_65, sum(t17.female) as F_30_65, sum(t17.trans) as T_30_65, sum(t17.unknown) as unknown_30_65
     into #temptable23
     from #temptable17 t17
     where t17._30_65=1
     group by t17.race, t17._30_65
     
     
     --'Cumulative Demographics over 66' 
     select distinct t17.race, sum(t17.male) as M_over_66, sum(t17.female) as F_over_66, sum(t17.trans) as T_over_66, sum(t17.unknown) as unknown_over_66
     into #temptable24
     from #temptable17 t17
     where t17.over_66=1
     group by t17.race
     
     --create file with all race and age rows
     select distinct race, M_under_15, F_under_15, T_under_15, unknown_under_15, 0 as M_15_19, 0 as F_15_19, 0 as T_15_19, 0 as Unknown_15_19
     ,0 as M_20_29, 0 as F_20_29, 0 as T_20_29, 0 as Unknown_20_29, 0 as M_30_65, 0 as F_30_65, 0 as T_30_65, 0 as Unknown_30_65, 0 as M_over_66, 0 as F_over_66, 0 as T_over_66, 0 as unknown_over_66
     into #temptable25
     from #temptable20
     
     union
     select distinct race, 0 as M_under_15, 0 as F_under_15, 0 as T_under_15, 0 as unknown_under_15, M_15_19, F_15_19, T_15_19, Unknown_15_19
     ,0 as M_20_29, 0 as F_20_29, 0 as T_20_29, 0 as Unknown_20_29, 0 as M_30_65, 0 as F_30_65, 0 as T_30_65, 0 as Unknown_30_65, 0 as M_over_66, 0 as F_over_66, 0 as T_over_66, 0 as unknown_over_66
     from #temptable21
     
     union 
     select distinct race, 0 as M_under_15, 0 as F_under_15, 0 as T_under_15, 0 as unknown_under_15, 0 as M_15_19, 0 as F_15_19, 0 as T_15_19, 0 as Unknown_15_19
     , M_20_29, F_20_29, T_20_29, Unknown_20_29, 0 as M_30_65, 0 as F_30_65, 0 as T_30_65, 0 as Unknown_30_65, 0 as M_over_66, 0 as F_over_66, 0 as T_over_66, 0 as unknown_over_66
     from #temptable22
     
     union 
     select distinct race, 0 as M_under_15, 0 as F_under_15, 0 as T_under_15, 0 as unknown_under_15, 0 as M_15_19, 0 as F_15_19, 0 as T_15_19, 0 as Unknown_15_19
     , 0 as M_20_29, 0 as F_20_29, 0 as T_20_29, 0 as Unknown_20_29, M_30_65, F_30_65, T_30_65, Unknown_30_65, 0 as M_over_66, 0 as F_over_66, 0 as T_over_66, 0 as unknown_over_66
     from #temptable23
     
     union 
     select distinct race, 0 as M_under_15, 0 as F_under_15, 0 as T_under_15, 0 as unknown_under_15, 0 as M_15_19, 0 as F_15_19, 0 as T_15_19, 0 as Unknown_15_19
     , 0 as M_20_29, 0 as F_20_29, 0 as T_20_29, 0 as Unknown_20_29, 0 as M_30_65, 0 as F_30_65, 0 as T_30_65, 0 as Unknown_30_65, M_over_66, F_over_66, T_over_66, unknown_over_66
     from #temptable24
     
     select 'This month demographics' as title
     select distinct race
     , sum(M_under_15) as M_under_15, sum(F_under_15) as F_under_15, sum(T_under_15) as T_under_15, sum(unknown_under_15) as unknown_under_15
     , sum(M_15_19) as M_15_19, sum(F_15_19) as F_15_19, sum(T_15_19) as T_15_19, sum(Unknown_15_19) as unknown_15_19
     , sum(M_20_29) as M_20_29, sum(F_20_29) as F_20_29, sum(T_20_29) as T_20_29, sum(Unknown_20_29) as unknown_20_29
     , sum(M_30_65) as M_30_65, sum(F_30_65) as F_30_65, sum(T_30_65) as T_30_65, sum(Unknown_30_65)as unknown_30_65
     , sum(M_over_66) as M_over_66, Sum(F_over_66) as F_over_66, sum(T_over_66) as T_over_66, sum(unknown_over_66) as unknown_over_66
     into #temptable26
     from #temptable25
     group by race
     select * from #temptable26
     select 'Totals' as Totals
     , sum(M_under_15) as M_under_15, sum(F_under_15) as F_under_15, sum(T_under_15) as T_under_15, sum(unknown_under_15) as unknown_under_15
     , sum(M_15_19) as M_15_19, sum(F_15_19) as F_15_19, sum(T_15_19) as T_15_19, sum(Unknown_15_19) as unknown_15_19
     , sum(M_20_29) as M_20_29, sum(F_20_29) as F_20_29, sum(T_20_29) as T_20_29, sum(Unknown_20_29) as unknown_20_29
     , sum(M_30_65) as M_30_65, sum(F_30_65) as F_30_65, sum(T_30_65) as T_30_65, sum(Unknown_30_65)as unknown_30_65
     , sum(M_over_66) as M_over_66, Sum(F_over_66) as F_over_66, sum(T_over_66) as T_over_66, sum(unknown_over_66) as unknown_over_66
     from #temptable26 
     
     --------------------------------------------------------------------------------------------------------------------------------------------
     --unique pts since October 1, 2021 (YTD)
     SELECT distinct p.controlno,
     p.pid,
     u.ufname,
     u.ulname,
     u.dob,
     Datediff(hour, u.ptdob, '2022-06-30') / 8766 AS age,
     case when DATEDIFF(hour,u.ptdob,'2022-06-30')/8766< 15 then 1 else 0 end as Under_15,
     case when (DATEDIFF(hour,u.ptdob,'2022-06-30')/8766>=15 and DATEDIFF(hour,u.ptdob,'2022-06-30')/8766<=19) then 1 else 0 end as _15_19,
     case when (DATEDIFF(hour,u.ptdob,'2022-06-30')/8766>=20 and DATEDIFF(hour,u.ptdob,'2022-06-30')/8766<=29) then 1 else 0 end as _20_29,
     case when (DATEDIFF(hour,u.ptdob,'2022-06-30')/8766>=30 and DATEDIFF(hour,u.ptdob,'2022-06-30')/8766<=65) then 1 else 0 end as _30_65,
     case when (DATEDIFF(hour,u.ptdob,'2022-06-30')/8766>=66) then 1 else 0 end as over_66,
     eth.name as ethnicity
     ,case when eth.name like 'Hispanic or Latino' then 1 else 0 end as Latino,
     u.sex
     INTO #temptablea27
     FROM   users u,
     enc e,
     patients p
     left join ethnicity eth on p.ethnicity=eth.code
     WHERE  p.pid = u.uid
     AND p.pid = e.patientid
     AND e.deleteflag = '0'
     AND e.date BETWEEN '2021-10-01' AND @enddate
     AND e.status = 'CHK'
     AND e.visittype LIKE 'EXCH%'
     and u.ulname not like 'Test'
     
     --for YTD pull race; Will have multiple rows for pts w more than one race
     select distinct ta27.pid, ro.name as race, 1 as count
     into #temptableaa
     from #temptablea27 ta27
     left join raceothers ro on ta27.pid=ro.pid
     
     --for YTD identify pts with more than one row from above
     select distinct taa.pid, sum(count) as count
     into #temptableab
     from #temptableaa taa
     group by taa.pid
     
     --classify patients YTD by race, using multiracial if they have more than one row in raceothers
     select distinct ta27.pid, ta27.ethnicity, case 
     when tab.count>=2 then 'Multiracial' 
     when taa.race like 'Black or African American' then 'Black/African American' 
     when taa.race like 'American Indian or Alaska Native' then 'American Indian/Alaska Native'
     when (taa.race like 'Native Hawaiian' or taa.race like 'Other Pacific Islander') then 'Native Hawaiian/Other Pacific Islander'
     when taa.race like 'Asian' then 'Asian'
     when (taa.race like '' or taa.race like 'Declined to Specify') then 'Other/Unknown'
     else taa.race end as Race
     into #temptableac
     from #temptablea27 ta27
     left join #temptableaa taa on ta27.pid=taa.pid
     left join #temptableab tab on ta27.pid=tab.pid
     
     */
    -- SOGI YTD*/
    /*
     --pull so 
     SELECT ta27.pid, pso.so_ID, soo.name as sexual_orientation, convert(date, pso.added_on) as so_date_updated
     into #temptablea6b
     FROM #temptablea27 ta27
     left join patient_sexual_orientation pso on ta27.pid=pso.patientid and pso.deleteflag=0
     left join sexual_orientation_options soo on pso.so_id=soo.id
     
     --pull gi  
     SELECT ta27.pid, pgi.gi_ID, gio.name as gender_identity, convert(date, pgi.added_on) as gi_date_updated
     into #temptablea7b
     FROM #temptablea27 ta27
     left join patient_gender_identity pgi on ta27.pid=pgi.patientid and pgi.deleteflag=0
     left join gender_identity_options gio on pgi.gi_id=gio.id
     
     
     --YTD demographics for Cumulative Demographic Report with ethnicity and race organized for that table
     SELECT DISTINCT ta27.pid
     ,ta27.under_15
     ,ta27._15_19
     ,ta27._20_29
     ,ta27._30_65
     ,ta27.over_66
     ,case when ta27.Latino=1 then '3_Latino' 
     when tac.race like 'Black%' then '1_Black'
     when (tac.race like 'Asian' or tac.race like 'Native%') then '4_API'
     when tac.race like 'White' then '2_White'
     else '5_Other/Unknown'  end as race
     , case when ta7b.gender_identity like '%trans%' then 1 else 0 end as Trans
     , case when ta27.sex like 'Female' then 1 else 0 end as Female
     ,case when ta27.sex like 'Male' then 1 else 0 end as male
     , case when (ta27.sex not like 'Female' and ta27.sex not like 'Male' and ta7b.gender_identity not like 'Trans') then 1 else 0 end as Unknown 
     into #temptablea17
     FROM #temptablea27 ta27
     left join #temptablea6b ta6b on ta27.pid=ta6b.pid
     left join #temptablea7b ta7b on ta27.pid=ta7b.pid
     left join #temptablec tac on ta27.pid=tac.pid
     
     --'Cumulative Demographics Under 15' 
     select distinct ta17.race, sum(ta17.male) as M_under_15, sum(ta17.female) as F_under_15, sum(ta17.trans) as T_under_15, sum(ta17.unknown) as unknown_under_15
     into #temptablea20
     from #temptablea17 ta17
     where ta17.under_15=1
     group by ta17.race
     
     --'Cumulative Demographics 15-19' 
     select distinct ta17.race, sum(ta17.male) as M_15_19, sum(ta17.female) as F_15_19, sum(ta17.trans) as T_15_19, sum(ta17.unknown) as unknown_15_19
     into #temptablea21
     from #temptablea17 ta17
     where ta17._15_19=1
     group by ta17.race
     
     --'Cumulative Demographics 20-29'
     select distinct ta17.race, sum(ta17.male) as M_20_29, sum(ta17.female) as F_20_29, sum(ta17.trans) as T_20_29, sum(ta17.unknown) as unknown_20_29
     into #temptablea22
     from #temptablea17 ta17
     where ta17._20_29=1
     group by ta17.race
     
     --'Cumulative Demographics 30-65' 
     select distinct ta17.race, sum(ta17.male) as M_30_65, sum(ta17.female) as F_30_65, sum(ta17.trans) as T_30_65, sum(ta17.unknown) as unknown_30_65
     into #temptablea23
     from #temptablea17 ta17
     where ta17._30_65=1
     group by ta17.race, ta17._30_65
     
     
     --'Cumulative Demographics over 66' 
     select distinct ta17.race, sum(ta17.male) as M_over_66, sum(ta17.female) as F_over_66, sum(ta17.trans) as T_over_66, sum(ta17.unknown) as unknown_over_66
     into #temptablea24
     from #temptablea17 ta17
     where ta17.over_66=1
     group by ta17.race
     
     --create file with all race and age rows
     select distinct race, M_under_15, F_under_15, T_under_15, unknown_under_15, 0 as M_15_19, 0 as F_15_19, 0 as T_15_19, 0 as Unknown_15_19
     ,0 as M_20_29, 0 as F_20_29, 0 as T_20_29, 0 as Unknown_20_29, 0 as M_30_65, 0 as F_30_65, 0 as T_30_65, 0 as Unknown_30_65, 0 as M_over_66, 0 as F_over_66, 0 as T_over_66, 0 as unknown_over_66
     into #temptablea25
     from #temptablea20
     
     union
     select distinct race, 0 as M_under_15, 0 as F_under_15, 0 as T_under_15, 0 as unknown_under_15, M_15_19, F_15_19, T_15_19, Unknown_15_19
     ,0 as M_20_29, 0 as F_20_29, 0 as T_20_29, 0 as Unknown_20_29, 0 as M_30_65, 0 as F_30_65, 0 as T_30_65, 0 as Unknown_30_65, 0 as M_over_66, 0 as F_over_66, 0 as T_over_66, 0 as unknown_over_66
     from #temptablea21
     
     union 
     select distinct race, 0 as M_under_15, 0 as F_under_15, 0 as T_under_15, 0 as unknown_under_15, 0 as M_15_19, 0 as F_15_19, 0 as T_15_19, 0 as Unknown_15_19
     , M_20_29, F_20_29, T_20_29, Unknown_20_29, 0 as M_30_65, 0 as F_30_65, 0 as T_30_65, 0 as Unknown_30_65, 0 as M_over_66, 0 as F_over_66, 0 as T_over_66, 0 as unknown_over_66
     from #temptablea22
     
     union 
     select distinct race, 0 as M_under_15, 0 as F_under_15, 0 as T_under_15, 0 as unknown_under_15, 0 as M_15_19, 0 as F_15_19, 0 as T_15_19, 0 as Unknown_15_19
     , 0 as M_20_29, 0 as F_20_29, 0 as T_20_29, 0 as Unknown_20_29, M_30_65, F_30_65, T_30_65, Unknown_30_65, 0 as M_over_66, 0 as F_over_66, 0 as T_over_66, 0 as unknown_over_66
     from #temptablea23
     
     union 
     select distinct race, 0 as M_under_15, 0 as F_under_15, 0 as T_under_15, 0 as unknown_under_15, 0 as M_15_19, 0 as F_15_19, 0 as T_15_19, 0 as Unknown_15_19
     , 0 as M_20_29, 0 as F_20_29, 0 as T_20_29, 0 as Unknown_20_29, 0 as M_30_65, 0 as F_30_65, 0 as T_30_65, 0 as Unknown_30_65, M_over_66, F_over_66, T_over_66, unknown_over_66
     from #temptablea24
     
     select 'YTD demographics' as title
     select distinct race
     , sum(M_under_15) as M_under_15, sum(F_under_15) as F_under_15, sum(T_under_15) as T_under_15, sum(unknown_under_15) as unknown_under_15
     , sum(M_15_19) as M_15_19, sum(F_15_19) as F_15_19, sum(T_15_19) as T_15_19, sum(Unknown_15_19) as unknown_15_19
     , sum(M_20_29) as M_20_29, sum(F_20_29) as F_20_29, sum(T_20_29) as T_20_29, sum(Unknown_20_29) as unknown_20_29
     , sum(M_30_65) as M_30_65, sum(F_30_65) as F_30_65, sum(T_30_65) as T_30_65, sum(Unknown_30_65)as unknown_30_65
     , sum(M_over_66) as M_over_66, Sum(F_over_66) as F_over_66, sum(T_over_66) as T_over_66, sum(unknown_over_66) as unknown_over_66
     into #temptablea26
     from #temptablea25
     group by race
     select * from #temptablea26
     select 'Totals' as Totals
     , sum(M_under_15) as M_under_15, sum(F_under_15) as F_under_15, sum(T_under_15) as T_under_15, sum(unknown_under_15) as unknown_under_15
     , sum(M_15_19) as M_15_19, sum(F_15_19) as F_15_19, sum(T_15_19) as T_15_19, sum(Unknown_15_19) as unknown_15_19
     , sum(M_20_29) as M_20_29, sum(F_20_29) as F_20_29, sum(T_20_29) as T_20_29, sum(Unknown_20_29) as unknown_20_29
     , sum(M_30_65) as M_30_65, sum(F_30_65) as F_30_65, sum(T_30_65) as T_30_65, sum(Unknown_30_65)as unknown_30_65
     , sum(M_over_66) as M_over_66, Sum(F_over_66) as F_over_66, sum(T_over_66) as T_over_66, sum(unknown_over_66) as unknown_over_66
     from #temptablea26 
     
     
     select  '' as'HIV PWID'
     SELECT distinct t1.pid,t1.sex,t1.age,tc.race
     FROM   labdata l, 
     items i, 
     enc e, 
     #temptable1 t1
     LEFT JOIN #temptablec tc on tc.pid=t1.pid
     WHERE  e.date BETWEEN @startdate AND @enddate
     and t1.pid=e.patientid
     AND e.encounterid = l.encounterid 
     AND i.itemid = l.itemid 
     AND l.itemid IN ( '250311', '302257', '292082', '262566', 
     '302207', '262567', '290543', '290147', 
     '316259', '290755', '250454', '291682', 
     '251611', '291793', '251628', '250433', '291962', '410525' ) 
     AND l.result <> '' 
     GROUP BY t1.pid, t1.age, t1.sex,tc.race
     */
    --select * from #temptable1